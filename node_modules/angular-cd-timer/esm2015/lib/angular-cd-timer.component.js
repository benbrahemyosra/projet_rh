import { Component, ElementRef, EventEmitter, Input, Output, Renderer2 } from '@angular/core';
export class CdTimerComponent {
    constructor(elt, renderer) {
        this.elt = elt;
        this.renderer = renderer;
        this.onStart = new EventEmitter();
        this.onStop = new EventEmitter();
        this.onTick = new EventEmitter();
        this.onComplete = new EventEmitter();
        // Initialization
        this.autoStart = true;
        this.startTime = 0;
        this.endTime = 0;
        this.timeoutId = null;
        this.countdown = false;
        this.format = 'default';
    }
    ngAfterViewInit() {
        const ngContentNode = this.elt.nativeElement.lastChild; // Get last child, defined by user or span
        this.ngContentSchema = ngContentNode ? ngContentNode.nodeValue : '';
        if (this.autoStart === undefined || this.autoStart === true) {
            this.start();
        }
    }
    ngOnDestroy() {
        this.resetTimeout();
    }
    /**
     * Start the timer
     */
    start() {
        this.initVar();
        this.resetTimeout();
        this.computeTimeUnits();
        this.startTickCount();
        this.onStart.emit(this);
    }
    /**
     * Resume the timer
     */
    resume() {
        this.resetTimeout();
        this.startTickCount();
    }
    /**
     * Stop the timer
     */
    stop() {
        this.clear();
        this.onStop.emit(this);
    }
    /**
     * Reset the timer
     */
    reset() {
        this.initVar();
        this.resetTimeout();
        this.clear();
        this.computeTimeUnits();
        this.renderText();
    }
    /**
     * Get the time information
     * @returns TimeInterface
     */
    get() {
        return {
            seconds: this.seconds,
            minutes: this.minutes,
            hours: this.hours,
            days: this.days,
            timer: this.timeoutId,
            tick_count: this.tickCounter
        };
    }
    /**
     * Initialize variable before start
     */
    initVar() {
        this.startTime = this.startTime || 0;
        this.endTime = this.endTime || 0;
        this.countdown = this.countdown || false;
        this.tickCounter = this.startTime;
        // Disable countdown if start time not defined
        if (this.countdown && this.startTime === 0) {
            this.countdown = false;
        }
        // Determine auto format
        if (!this.format) {
            this.format = (this.ngContentSchema.length > 5) ? 'user' : 'default';
        }
    }
    /**
     * Reset timeout
     */
    resetTimeout() {
        if (this.timeoutId) {
            clearInterval(this.timeoutId);
        }
    }
    /**
     * Render the time to DOM
     */
    renderText() {
        let outputText;
        if (this.format === 'user') {
            // User presentation
            const items = {
                'seconds': this.seconds,
                'minutes': this.minutes,
                'hours': this.hours,
                'days': this.days
            };
            outputText = this.ngContentSchema;
            for (const key of Object.keys(items)) {
                outputText = outputText.replace('[' + key + ']', items[key].toString());
            }
        }
        else if (this.format === 'intelli') {
            // Intelli presentation
            outputText = '';
            if (this.days > 0) {
                outputText += this.days.toString() + 'day' + ((this.days > 1) ? 's' : '') + ' ';
            }
            if ((this.hours > 0) || (this.days > 0)) {
                outputText += this.hours.toString() + 'h ';
            }
            if (((this.minutes > 0) || (this.hours > 0)) && (this.days === 0)) {
                outputText += this.minutes.toString().padStart(2, '0') + 'min ';
            }
            if ((this.hours === 0) && (this.days === 0)) {
                outputText += this.seconds.toString().padStart(2, '0') + 's';
            }
        }
        else if (this.format === 'hms') {
            // Hms presentation
            outputText = this.hours.toString().padStart(2, '0') + ':';
            outputText += this.minutes.toString().padStart(2, '0') + ':';
            outputText += this.seconds.toString().padStart(2, '0');
        }
        else {
            // Default presentation
            outputText = this.days.toString() + 'd ';
            outputText += this.hours.toString() + 'h ';
            outputText += this.minutes.toString() + 'm ';
            outputText += this.seconds.toString() + 's';
        }
        this.renderer.setProperty(this.elt.nativeElement, 'innerHTML', outputText);
    }
    clear() {
        this.resetTimeout();
        this.timeoutId = null;
    }
    /**
     * Compute each unit (seconds, minutes, hours, days) for further manipulation
     * @protected
     */
    computeTimeUnits() {
        if (!this.maxTimeUnit || this.maxTimeUnit === 'day') {
            this.seconds = Math.floor(this.tickCounter % 60);
            this.minutes = Math.floor((this.tickCounter / 60) % 60);
            this.hours = Math.floor((this.tickCounter / 3600) % 24);
            this.days = Math.floor((this.tickCounter / 3600) / 24);
        }
        else if (this.maxTimeUnit === 'second') {
            this.seconds = this.tickCounter;
            this.minutes = 0;
            this.hours = 0;
            this.days = 0;
        }
        else if (this.maxTimeUnit === 'minute') {
            this.seconds = Math.floor(this.tickCounter % 60);
            this.minutes = Math.floor(this.tickCounter / 60);
            this.hours = 0;
            this.days = 0;
        }
        else if (this.maxTimeUnit === 'hour') {
            this.seconds = Math.floor(this.tickCounter % 60);
            this.minutes = Math.floor((this.tickCounter / 60) % 60);
            this.hours = Math.floor(this.tickCounter / 3600);
            this.days = 0;
        }
        this.renderText();
    }
    /**
     * Start tick count, base of this component
     * @protected
     */
    startTickCount() {
        const that = this;
        that.timeoutId = setInterval(function () {
            let counter;
            if (that.countdown) {
                // Compute finish counter for countdown
                counter = that.tickCounter;
                if (that.startTime > that.endTime) {
                    counter = that.tickCounter - that.endTime - 1;
                }
            }
            else {
                // Compute finish counter for timer
                counter = that.tickCounter - that.startTime;
                if (that.endTime > that.startTime) {
                    counter = that.endTime - that.tickCounter - 1;
                }
            }
            that.computeTimeUnits();
            const timer = {
                seconds: that.seconds,
                minutes: that.minutes,
                hours: that.hours,
                days: that.days,
                timer: that.timeoutId,
                tick_count: that.tickCounter
            };
            that.onTick.emit(timer);
            if (counter < 0) {
                that.stop();
                that.onComplete.emit(that);
                return;
            }
            if (that.countdown) {
                that.tickCounter--;
            }
            else {
                that.tickCounter++;
            }
        }, 1000); // Each seconds
    }
}
CdTimerComponent.decorators = [
    { type: Component, args: [{
                selector: 'cd-timer',
                template: ' <ng-content></ng-content>'
            },] }
];
CdTimerComponent.ctorParameters = () => [
    { type: ElementRef },
    { type: Renderer2 }
];
CdTimerComponent.propDecorators = {
    startTime: [{ type: Input }],
    endTime: [{ type: Input }],
    countdown: [{ type: Input }],
    autoStart: [{ type: Input }],
    maxTimeUnit: [{ type: Input }],
    format: [{ type: Input }],
    onStart: [{ type: Output }],
    onStop: [{ type: Output }],
    onTick: [{ type: Output }],
    onComplete: [{ type: Output }]
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYW5ndWxhci1jZC10aW1lci5jb21wb25lbnQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9wcm9qZWN0cy9hbmd1bGFyLWNkLXRpbWVyL3NyYy9saWIvYW5ndWxhci1jZC10aW1lci5jb21wb25lbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQ0EsT0FBTyxFQUVMLFNBQVMsRUFBRSxVQUFVLEVBQUUsWUFBWSxFQUFFLEtBQUssRUFBYSxNQUFNLEVBQUUsU0FBUyxFQUN6RSxNQUFNLGVBQWUsQ0FBQztBQU92QixNQUFNLE9BQU8sZ0JBQWdCO0lBcUIzQixZQUFvQixHQUFlLEVBQVUsUUFBbUI7UUFBNUMsUUFBRyxHQUFILEdBQUcsQ0FBWTtRQUFVLGFBQVEsR0FBUixRQUFRLENBQVc7UUFMdEQsWUFBTyxHQUFtQyxJQUFJLFlBQVksRUFBb0IsQ0FBQztRQUMvRSxXQUFNLEdBQW1DLElBQUksWUFBWSxFQUFvQixDQUFDO1FBQzlFLFdBQU0sR0FBZ0MsSUFBSSxZQUFZLEVBQWlCLENBQUM7UUFDeEUsZUFBVSxHQUFtQyxJQUFJLFlBQVksRUFBb0IsQ0FBQztRQUcxRixpQkFBaUI7UUFDakIsSUFBSSxDQUFDLFNBQVMsR0FBSSxJQUFJLENBQUM7UUFDdkIsSUFBSSxDQUFDLFNBQVMsR0FBSSxDQUFDLENBQUM7UUFDcEIsSUFBSSxDQUFDLE9BQU8sR0FBTSxDQUFDLENBQUM7UUFDcEIsSUFBSSxDQUFDLFNBQVMsR0FBSSxJQUFJLENBQUM7UUFDdkIsSUFBSSxDQUFDLFNBQVMsR0FBSSxLQUFLLENBQUM7UUFDeEIsSUFBSSxDQUFDLE1BQU0sR0FBTyxTQUFTLENBQUM7SUFDOUIsQ0FBQztJQUVELGVBQWU7UUFDYixNQUFNLGFBQWEsR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLGFBQWEsQ0FBQyxTQUFTLENBQUMsQ0FBSSwwQ0FBMEM7UUFDckcsSUFBSSxDQUFDLGVBQWUsR0FBRyxhQUFhLENBQUMsQ0FBQyxDQUFDLGFBQWEsQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQztRQUNwRSxJQUFJLElBQUksQ0FBQyxTQUFTLEtBQUssU0FBUyxJQUFJLElBQUksQ0FBQyxTQUFTLEtBQUssSUFBSSxFQUFFO1lBQzNELElBQUksQ0FBQyxLQUFLLEVBQUUsQ0FBQztTQUNkO0lBQ0gsQ0FBQztJQUVELFdBQVc7UUFDVCxJQUFJLENBQUMsWUFBWSxFQUFFLENBQUM7SUFDdEIsQ0FBQztJQUVEOztPQUVHO0lBQ0ksS0FBSztRQUNWLElBQUksQ0FBQyxPQUFPLEVBQUUsQ0FBQztRQUNmLElBQUksQ0FBQyxZQUFZLEVBQUUsQ0FBQztRQUNwQixJQUFJLENBQUMsZ0JBQWdCLEVBQUUsQ0FBQztRQUN4QixJQUFJLENBQUMsY0FBYyxFQUFFLENBQUM7UUFFdEIsSUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDMUIsQ0FBQztJQUVEOztPQUVHO0lBQ0ksTUFBTTtRQUNYLElBQUksQ0FBQyxZQUFZLEVBQUUsQ0FBQztRQUVwQixJQUFJLENBQUMsY0FBYyxFQUFFLENBQUM7SUFDeEIsQ0FBQztJQUVEOztPQUVHO0lBQ0ksSUFBSTtRQUNULElBQUksQ0FBQyxLQUFLLEVBQUUsQ0FBQztRQUViLElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQ3pCLENBQUM7SUFFRDs7T0FFRztJQUNJLEtBQUs7UUFDVixJQUFJLENBQUMsT0FBTyxFQUFFLENBQUM7UUFDZixJQUFJLENBQUMsWUFBWSxFQUFFLENBQUM7UUFDcEIsSUFBSSxDQUFDLEtBQUssRUFBRSxDQUFDO1FBQ2IsSUFBSSxDQUFDLGdCQUFnQixFQUFFLENBQUM7UUFDeEIsSUFBSSxDQUFDLFVBQVUsRUFBRSxDQUFDO0lBQ3BCLENBQUM7SUFFRDs7O09BR0c7SUFDSSxHQUFHO1FBQ1IsT0FBTztZQUNMLE9BQU8sRUFBRSxJQUFJLENBQUMsT0FBTztZQUNyQixPQUFPLEVBQUUsSUFBSSxDQUFDLE9BQU87WUFDckIsS0FBSyxFQUFFLElBQUksQ0FBQyxLQUFLO1lBQ2pCLElBQUksRUFBRSxJQUFJLENBQUMsSUFBSTtZQUNmLEtBQUssRUFBRSxJQUFJLENBQUMsU0FBUztZQUNyQixVQUFVLEVBQUUsSUFBSSxDQUFDLFdBQVc7U0FDN0IsQ0FBQztJQUNKLENBQUM7SUFFRDs7T0FFRztJQUNLLE9BQU87UUFDYixJQUFJLENBQUMsU0FBUyxHQUFHLElBQUksQ0FBQyxTQUFTLElBQUksQ0FBQyxDQUFDO1FBQ3JDLElBQUksQ0FBQyxPQUFPLEdBQUssSUFBSSxDQUFDLE9BQU8sSUFBSSxDQUFDLENBQUM7UUFDbkMsSUFBSSxDQUFDLFNBQVMsR0FBRyxJQUFJLENBQUMsU0FBUyxJQUFJLEtBQUssQ0FBQztRQUN6QyxJQUFJLENBQUMsV0FBVyxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUM7UUFFbEMsOENBQThDO1FBQzlDLElBQUksSUFBSSxDQUFDLFNBQVMsSUFBSSxJQUFJLENBQUMsU0FBUyxLQUFLLENBQUMsRUFBRTtZQUMxQyxJQUFJLENBQUMsU0FBUyxHQUFHLEtBQUssQ0FBQztTQUN4QjtRQUVELHdCQUF3QjtRQUN4QixJQUFJLENBQUMsSUFBSSxDQUFDLE1BQU0sRUFBRTtZQUNoQixJQUFJLENBQUMsTUFBTSxHQUFHLENBQUMsSUFBSSxDQUFDLGVBQWUsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsU0FBUyxDQUFDO1NBQ3RFO0lBQ0gsQ0FBQztJQUVEOztPQUVHO0lBQ0ssWUFBWTtRQUNsQixJQUFJLElBQUksQ0FBQyxTQUFTLEVBQUU7WUFDbEIsYUFBYSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQztTQUMvQjtJQUNILENBQUM7SUFFRDs7T0FFRztJQUNLLFVBQVU7UUFDaEIsSUFBSSxVQUFVLENBQUM7UUFDZixJQUFJLElBQUksQ0FBQyxNQUFNLEtBQUssTUFBTSxFQUFFO1lBQzFCLG9CQUFvQjtZQUNwQixNQUFNLEtBQUssR0FBRztnQkFDWixTQUFTLEVBQUUsSUFBSSxDQUFDLE9BQU87Z0JBQ3ZCLFNBQVMsRUFBRSxJQUFJLENBQUMsT0FBTztnQkFDdkIsT0FBTyxFQUFFLElBQUksQ0FBQyxLQUFLO2dCQUNuQixNQUFNLEVBQUUsSUFBSSxDQUFDLElBQUk7YUFDbEIsQ0FBQztZQUVGLFVBQVUsR0FBRyxJQUFJLENBQUMsZUFBZSxDQUFDO1lBRWxDLEtBQUssTUFBTSxHQUFHLElBQUksTUFBTSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsRUFBRTtnQkFDcEMsVUFBVSxHQUFHLFVBQVUsQ0FBQyxPQUFPLENBQUMsR0FBRyxHQUFHLEdBQUcsR0FBRyxHQUFHLEVBQUcsS0FBYSxDQUFDLEdBQUcsQ0FBQyxDQUFDLFFBQVEsRUFBRSxDQUFDLENBQUM7YUFDbEY7U0FDRjthQUFNLElBQUksSUFBSSxDQUFDLE1BQU0sS0FBSyxTQUFTLEVBQUU7WUFDcEMsdUJBQXVCO1lBQ3ZCLFVBQVUsR0FBRyxFQUFFLENBQUM7WUFDaEIsSUFBSSxJQUFJLENBQUMsSUFBSSxHQUFHLENBQUMsRUFBRTtnQkFDakIsVUFBVSxJQUFJLElBQUksQ0FBQyxJQUFJLENBQUMsUUFBUSxFQUFFLEdBQUcsS0FBSyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUMsSUFBSSxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxHQUFHLEdBQUcsQ0FBQzthQUNqRjtZQUNELElBQUksQ0FBQyxJQUFJLENBQUMsS0FBSyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksR0FBRyxDQUFDLENBQUMsRUFBRTtnQkFDdkMsVUFBVSxJQUFJLElBQUksQ0FBQyxLQUFLLENBQUMsUUFBUSxFQUFFLEdBQUcsSUFBSSxDQUFDO2FBQzVDO1lBQ0QsSUFBSSxDQUFDLENBQUMsSUFBSSxDQUFDLE9BQU8sR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxLQUFLLEdBQUcsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLEtBQUssQ0FBQyxDQUFDLEVBQUU7Z0JBQ2pFLFVBQVUsSUFBSSxJQUFJLENBQUMsT0FBTyxDQUFDLFFBQVEsRUFBRSxDQUFDLFFBQVEsQ0FBQyxDQUFDLEVBQUUsR0FBRyxDQUFDLEdBQUcsTUFBTSxDQUFDO2FBQ2pFO1lBQ0QsSUFBSSxDQUFDLElBQUksQ0FBQyxLQUFLLEtBQUssQ0FBQyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxLQUFLLENBQUMsQ0FBQyxFQUFFO2dCQUMzQyxVQUFVLElBQUksSUFBSSxDQUFDLE9BQU8sQ0FBQyxRQUFRLEVBQUUsQ0FBQyxRQUFRLENBQUMsQ0FBQyxFQUFFLEdBQUcsQ0FBQyxHQUFHLEdBQUcsQ0FBQzthQUM5RDtTQUNGO2FBQU0sSUFBSSxJQUFJLENBQUMsTUFBTSxLQUFLLEtBQUssRUFBRTtZQUNoQyxtQkFBbUI7WUFDbkIsVUFBVSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsUUFBUSxFQUFFLENBQUMsUUFBUSxDQUFDLENBQUMsRUFBRSxHQUFHLENBQUMsR0FBRyxHQUFHLENBQUM7WUFDMUQsVUFBVSxJQUFJLElBQUksQ0FBQyxPQUFPLENBQUMsUUFBUSxFQUFFLENBQUMsUUFBUSxDQUFDLENBQUMsRUFBRSxHQUFHLENBQUMsR0FBRyxHQUFHLENBQUM7WUFDN0QsVUFBVSxJQUFJLElBQUksQ0FBQyxPQUFPLENBQUMsUUFBUSxFQUFFLENBQUMsUUFBUSxDQUFDLENBQUMsRUFBRSxHQUFHLENBQUMsQ0FBQztTQUN4RDthQUFNO1lBQ0wsdUJBQXVCO1lBQ3ZCLFVBQVUsR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLFFBQVEsRUFBRSxHQUFHLElBQUksQ0FBQztZQUN6QyxVQUFVLElBQUksSUFBSSxDQUFDLEtBQUssQ0FBQyxRQUFRLEVBQUUsR0FBRyxJQUFJLENBQUM7WUFDM0MsVUFBVSxJQUFJLElBQUksQ0FBQyxPQUFPLENBQUMsUUFBUSxFQUFFLEdBQUcsSUFBSSxDQUFDO1lBQzdDLFVBQVUsSUFBSSxJQUFJLENBQUMsT0FBTyxDQUFDLFFBQVEsRUFBRSxHQUFHLEdBQUcsQ0FBQztTQUM3QztRQUVELElBQUksQ0FBQyxRQUFRLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsYUFBYSxFQUFFLFdBQVcsRUFBRSxVQUFVLENBQUMsQ0FBQztJQUM3RSxDQUFDO0lBRU8sS0FBSztRQUNYLElBQUksQ0FBQyxZQUFZLEVBQUUsQ0FBQztRQUNwQixJQUFJLENBQUMsU0FBUyxHQUFHLElBQUksQ0FBQztJQUN4QixDQUFDO0lBRUQ7OztPQUdHO0lBQ08sZ0JBQWdCO1FBQ3hCLElBQUksQ0FBQyxJQUFJLENBQUMsV0FBVyxJQUFJLElBQUksQ0FBQyxXQUFXLEtBQUssS0FBSyxFQUFFO1lBQ25ELElBQUksQ0FBQyxPQUFPLEdBQUksSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsV0FBVyxHQUFHLEVBQUUsQ0FBQyxDQUFDO1lBQ2xELElBQUksQ0FBQyxPQUFPLEdBQUksSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLElBQUksQ0FBQyxXQUFXLEdBQUcsRUFBRSxDQUFDLEdBQUcsRUFBRSxDQUFDLENBQUM7WUFDekQsSUFBSSxDQUFDLEtBQUssR0FBTSxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUMsSUFBSSxDQUFDLFdBQVcsR0FBRyxJQUFJLENBQUMsR0FBRyxFQUFFLENBQUMsQ0FBQztZQUMzRCxJQUFJLENBQUMsSUFBSSxHQUFPLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxJQUFJLENBQUMsV0FBVyxHQUFHLElBQUksQ0FBQyxHQUFHLEVBQUUsQ0FBQyxDQUFDO1NBQzVEO2FBQU0sSUFBSSxJQUFJLENBQUMsV0FBVyxLQUFLLFFBQVEsRUFBRTtZQUN4QyxJQUFJLENBQUMsT0FBTyxHQUFJLElBQUksQ0FBQyxXQUFXLENBQUM7WUFDakMsSUFBSSxDQUFDLE9BQU8sR0FBSSxDQUFDLENBQUM7WUFDbEIsSUFBSSxDQUFDLEtBQUssR0FBTSxDQUFDLENBQUM7WUFDbEIsSUFBSSxDQUFDLElBQUksR0FBTyxDQUFDLENBQUM7U0FDbkI7YUFBTSxJQUFJLElBQUksQ0FBQyxXQUFXLEtBQUssUUFBUSxFQUFFO1lBQ3hDLElBQUksQ0FBQyxPQUFPLEdBQUksSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsV0FBVyxHQUFHLEVBQUUsQ0FBQyxDQUFDO1lBQ2xELElBQUksQ0FBQyxPQUFPLEdBQUksSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsV0FBVyxHQUFHLEVBQUUsQ0FBQyxDQUFDO1lBQ2xELElBQUksQ0FBQyxLQUFLLEdBQU0sQ0FBQyxDQUFDO1lBQ2xCLElBQUksQ0FBQyxJQUFJLEdBQU8sQ0FBQyxDQUFDO1NBQ25CO2FBQU0sSUFBSSxJQUFJLENBQUMsV0FBVyxLQUFLLE1BQU0sRUFBRTtZQUN0QyxJQUFJLENBQUMsT0FBTyxHQUFJLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLFdBQVcsR0FBRyxFQUFFLENBQUMsQ0FBQztZQUNsRCxJQUFJLENBQUMsT0FBTyxHQUFJLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxJQUFJLENBQUMsV0FBVyxHQUFHLEVBQUUsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxDQUFDO1lBQ3pELElBQUksQ0FBQyxLQUFLLEdBQU0sSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsV0FBVyxHQUFHLElBQUksQ0FBQyxDQUFDO1lBQ3BELElBQUksQ0FBQyxJQUFJLEdBQU8sQ0FBQyxDQUFDO1NBQ25CO1FBRUQsSUFBSSxDQUFDLFVBQVUsRUFBRSxDQUFDO0lBQ3BCLENBQUM7SUFFRDs7O09BR0c7SUFDTyxjQUFjO1FBQ3RCLE1BQU0sSUFBSSxHQUFHLElBQUksQ0FBQztRQUVsQixJQUFJLENBQUMsU0FBUyxHQUFHLFdBQVcsQ0FBQztZQUMzQixJQUFJLE9BQU8sQ0FBQztZQUVaLElBQUksSUFBSSxDQUFDLFNBQVMsRUFBRTtnQkFDbEIsdUNBQXVDO2dCQUN2QyxPQUFPLEdBQUcsSUFBSSxDQUFDLFdBQVcsQ0FBQztnQkFFM0IsSUFBSSxJQUFJLENBQUMsU0FBUyxHQUFHLElBQUksQ0FBQyxPQUFPLEVBQUU7b0JBQ2pDLE9BQU8sR0FBRyxJQUFJLENBQUMsV0FBVyxHQUFHLElBQUksQ0FBQyxPQUFPLEdBQUcsQ0FBQyxDQUFDO2lCQUMvQzthQUNGO2lCQUFNO2dCQUNMLG1DQUFtQztnQkFDbkMsT0FBTyxHQUFHLElBQUksQ0FBQyxXQUFXLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQztnQkFFNUMsSUFBSSxJQUFJLENBQUMsT0FBTyxHQUFHLElBQUksQ0FBQyxTQUFTLEVBQUU7b0JBQ2pDLE9BQU8sR0FBRyxJQUFJLENBQUMsT0FBTyxHQUFHLElBQUksQ0FBQyxXQUFXLEdBQUcsQ0FBQyxDQUFDO2lCQUMvQzthQUNGO1lBRUQsSUFBSSxDQUFDLGdCQUFnQixFQUFFLENBQUM7WUFFeEIsTUFBTSxLQUFLLEdBQWtCO2dCQUMzQixPQUFPLEVBQUUsSUFBSSxDQUFDLE9BQU87Z0JBQ3JCLE9BQU8sRUFBRSxJQUFJLENBQUMsT0FBTztnQkFDckIsS0FBSyxFQUFFLElBQUksQ0FBQyxLQUFLO2dCQUNqQixJQUFJLEVBQUUsSUFBSSxDQUFDLElBQUk7Z0JBQ2YsS0FBSyxFQUFFLElBQUksQ0FBQyxTQUFTO2dCQUNyQixVQUFVLEVBQUUsSUFBSSxDQUFDLFdBQVc7YUFDN0IsQ0FBQztZQUVGLElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDO1lBRXhCLElBQUksT0FBTyxHQUFHLENBQUMsRUFBRTtnQkFDZixJQUFJLENBQUMsSUFBSSxFQUFFLENBQUM7Z0JBRVosSUFBSSxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7Z0JBQzNCLE9BQU87YUFDUjtZQUVELElBQUksSUFBSSxDQUFDLFNBQVMsRUFBRTtnQkFDbEIsSUFBSSxDQUFDLFdBQVcsRUFBRSxDQUFDO2FBQ3BCO2lCQUFNO2dCQUNMLElBQUksQ0FBQyxXQUFXLEVBQUUsQ0FBQzthQUNwQjtRQUNILENBQUMsRUFBRSxJQUFJLENBQUMsQ0FBQyxDQUFDLGVBQWU7SUFDM0IsQ0FBQzs7O1lBN1FGLFNBQVMsU0FBQztnQkFDVCxRQUFRLEVBQUUsVUFBVTtnQkFDcEIsUUFBUSxFQUFFLDRCQUE0QjthQUN2Qzs7O1lBUFksVUFBVTtZQUEwQyxTQUFTOzs7d0JBa0J2RSxLQUFLO3NCQUNMLEtBQUs7d0JBQ0wsS0FBSzt3QkFDTCxLQUFLOzBCQUNMLEtBQUs7cUJBQ0wsS0FBSztzQkFDTCxNQUFNO3FCQUNOLE1BQU07cUJBQ04sTUFBTTt5QkFDTixNQUFNIiwic291cmNlc0NvbnRlbnQiOlsiXG5pbXBvcnQge1xuICBBZnRlclZpZXdJbml0LFxuICBDb21wb25lbnQsIEVsZW1lbnRSZWYsIEV2ZW50RW1pdHRlciwgSW5wdXQsIE9uRGVzdHJveSwgT3V0cHV0LCBSZW5kZXJlcjJcbn0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQge1RpbWVJbnRlcmZhY2V9IGZyb20gJy4vYW5ndWxhci1jZC10aW1lci5pbnRlcmZhY2UnO1xuXG5AQ29tcG9uZW50KHtcbiAgc2VsZWN0b3I6ICdjZC10aW1lcicsXG4gIHRlbXBsYXRlOiAnIDxuZy1jb250ZW50PjwvbmctY29udGVudD4nXG59KVxuZXhwb3J0IGNsYXNzIENkVGltZXJDb21wb25lbnQgaW1wbGVtZW50cyBBZnRlclZpZXdJbml0LCBPbkRlc3Ryb3kge1xuICBwcml2YXRlIHRpbWVvdXRJZDogYW55O1xuICBwcml2YXRlIHRpY2tDb3VudGVyOiBudW1iZXI7XG4gIHByaXZhdGUgbmdDb250ZW50U2NoZW1hOiBzdHJpbmc7XG5cbiAgcHJpdmF0ZSBzZWNvbmRzOiBudW1iZXI7XG4gIHByaXZhdGUgbWludXRlczogbnVtYmVyO1xuICBwcml2YXRlIGhvdXJzOiBudW1iZXI7XG4gIHByaXZhdGUgZGF5czogbnVtYmVyO1xuXG4gIEBJbnB1dCgpIHN0YXJ0VGltZTogbnVtYmVyO1xuICBASW5wdXQoKSBlbmRUaW1lOiBudW1iZXI7XG4gIEBJbnB1dCgpIGNvdW50ZG93bjogYm9vbGVhbjtcbiAgQElucHV0KCkgYXV0b1N0YXJ0OiBib29sZWFuO1xuICBASW5wdXQoKSBtYXhUaW1lVW5pdDogc3RyaW5nO1xuICBASW5wdXQoKSBmb3JtYXQ6IHN0cmluZztcbiAgQE91dHB1dCgpIG9uU3RhcnQ6IEV2ZW50RW1pdHRlcjxDZFRpbWVyQ29tcG9uZW50PiA9IG5ldyBFdmVudEVtaXR0ZXI8Q2RUaW1lckNvbXBvbmVudD4oKTtcbiAgQE91dHB1dCgpIG9uU3RvcDogRXZlbnRFbWl0dGVyPENkVGltZXJDb21wb25lbnQ+ID0gbmV3IEV2ZW50RW1pdHRlcjxDZFRpbWVyQ29tcG9uZW50PigpO1xuICBAT3V0cHV0KCkgb25UaWNrOiBFdmVudEVtaXR0ZXI8VGltZUludGVyZmFjZT4gPSBuZXcgRXZlbnRFbWl0dGVyPFRpbWVJbnRlcmZhY2U+KCk7XG4gIEBPdXRwdXQoKSBvbkNvbXBsZXRlOiBFdmVudEVtaXR0ZXI8Q2RUaW1lckNvbXBvbmVudD4gPSBuZXcgRXZlbnRFbWl0dGVyPENkVGltZXJDb21wb25lbnQ+KCk7XG5cbiAgY29uc3RydWN0b3IocHJpdmF0ZSBlbHQ6IEVsZW1lbnRSZWYsIHByaXZhdGUgcmVuZGVyZXI6IFJlbmRlcmVyMikge1xuICAgIC8vIEluaXRpYWxpemF0aW9uXG4gICAgdGhpcy5hdXRvU3RhcnQgID0gdHJ1ZTtcbiAgICB0aGlzLnN0YXJ0VGltZSAgPSAwO1xuICAgIHRoaXMuZW5kVGltZSAgICA9IDA7XG4gICAgdGhpcy50aW1lb3V0SWQgID0gbnVsbDtcbiAgICB0aGlzLmNvdW50ZG93biAgPSBmYWxzZTtcbiAgICB0aGlzLmZvcm1hdCAgICAgPSAnZGVmYXVsdCc7XG4gIH1cblxuICBuZ0FmdGVyVmlld0luaXQoKSB7XG4gICAgY29uc3QgbmdDb250ZW50Tm9kZSA9IHRoaXMuZWx0Lm5hdGl2ZUVsZW1lbnQubGFzdENoaWxkOyAgICAvLyBHZXQgbGFzdCBjaGlsZCwgZGVmaW5lZCBieSB1c2VyIG9yIHNwYW5cbiAgICB0aGlzLm5nQ29udGVudFNjaGVtYSA9IG5nQ29udGVudE5vZGUgPyBuZ0NvbnRlbnROb2RlLm5vZGVWYWx1ZSA6ICcnO1xuICAgIGlmICh0aGlzLmF1dG9TdGFydCA9PT0gdW5kZWZpbmVkIHx8IHRoaXMuYXV0b1N0YXJ0ID09PSB0cnVlKSB7XG4gICAgICB0aGlzLnN0YXJ0KCk7XG4gICAgfVxuICB9XG5cbiAgbmdPbkRlc3Ryb3koKSB7XG4gICAgdGhpcy5yZXNldFRpbWVvdXQoKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBTdGFydCB0aGUgdGltZXJcbiAgICovXG4gIHB1YmxpYyBzdGFydCgpIHtcbiAgICB0aGlzLmluaXRWYXIoKTtcbiAgICB0aGlzLnJlc2V0VGltZW91dCgpO1xuICAgIHRoaXMuY29tcHV0ZVRpbWVVbml0cygpO1xuICAgIHRoaXMuc3RhcnRUaWNrQ291bnQoKTtcblxuICAgIHRoaXMub25TdGFydC5lbWl0KHRoaXMpO1xuICB9XG5cbiAgLyoqXG4gICAqIFJlc3VtZSB0aGUgdGltZXJcbiAgICovXG4gIHB1YmxpYyByZXN1bWUoKSB7XG4gICAgdGhpcy5yZXNldFRpbWVvdXQoKTtcblxuICAgIHRoaXMuc3RhcnRUaWNrQ291bnQoKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBTdG9wIHRoZSB0aW1lclxuICAgKi9cbiAgcHVibGljIHN0b3AoKSB7XG4gICAgdGhpcy5jbGVhcigpO1xuXG4gICAgdGhpcy5vblN0b3AuZW1pdCh0aGlzKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZXNldCB0aGUgdGltZXJcbiAgICovXG4gIHB1YmxpYyByZXNldCgpIHtcbiAgICB0aGlzLmluaXRWYXIoKTtcbiAgICB0aGlzLnJlc2V0VGltZW91dCgpO1xuICAgIHRoaXMuY2xlYXIoKTtcbiAgICB0aGlzLmNvbXB1dGVUaW1lVW5pdHMoKTtcbiAgICB0aGlzLnJlbmRlclRleHQoKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBHZXQgdGhlIHRpbWUgaW5mb3JtYXRpb25cbiAgICogQHJldHVybnMgVGltZUludGVyZmFjZVxuICAgKi9cbiAgcHVibGljIGdldCgpIHtcbiAgICByZXR1cm4ge1xuICAgICAgc2Vjb25kczogdGhpcy5zZWNvbmRzLFxuICAgICAgbWludXRlczogdGhpcy5taW51dGVzLFxuICAgICAgaG91cnM6IHRoaXMuaG91cnMsXG4gICAgICBkYXlzOiB0aGlzLmRheXMsXG4gICAgICB0aW1lcjogdGhpcy50aW1lb3V0SWQsXG4gICAgICB0aWNrX2NvdW50OiB0aGlzLnRpY2tDb3VudGVyXG4gICAgfTtcbiAgfVxuXG4gIC8qKlxuICAgKiBJbml0aWFsaXplIHZhcmlhYmxlIGJlZm9yZSBzdGFydFxuICAgKi9cbiAgcHJpdmF0ZSBpbml0VmFyKCkge1xuICAgIHRoaXMuc3RhcnRUaW1lID0gdGhpcy5zdGFydFRpbWUgfHwgMDtcbiAgICB0aGlzLmVuZFRpbWUgICA9IHRoaXMuZW5kVGltZSB8fCAwO1xuICAgIHRoaXMuY291bnRkb3duID0gdGhpcy5jb3VudGRvd24gfHwgZmFsc2U7XG4gICAgdGhpcy50aWNrQ291bnRlciA9IHRoaXMuc3RhcnRUaW1lO1xuXG4gICAgLy8gRGlzYWJsZSBjb3VudGRvd24gaWYgc3RhcnQgdGltZSBub3QgZGVmaW5lZFxuICAgIGlmICh0aGlzLmNvdW50ZG93biAmJiB0aGlzLnN0YXJ0VGltZSA9PT0gMCkge1xuICAgICAgdGhpcy5jb3VudGRvd24gPSBmYWxzZTtcbiAgICB9XG5cbiAgICAvLyBEZXRlcm1pbmUgYXV0byBmb3JtYXRcbiAgICBpZiAoIXRoaXMuZm9ybWF0KSB7XG4gICAgICB0aGlzLmZvcm1hdCA9ICh0aGlzLm5nQ29udGVudFNjaGVtYS5sZW5ndGggPiA1KSA/ICd1c2VyJyA6ICdkZWZhdWx0JztcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogUmVzZXQgdGltZW91dFxuICAgKi9cbiAgcHJpdmF0ZSByZXNldFRpbWVvdXQoKSB7XG4gICAgaWYgKHRoaXMudGltZW91dElkKSB7XG4gICAgICBjbGVhckludGVydmFsKHRoaXMudGltZW91dElkKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogUmVuZGVyIHRoZSB0aW1lIHRvIERPTVxuICAgKi9cbiAgcHJpdmF0ZSByZW5kZXJUZXh0KCkge1xuICAgIGxldCBvdXRwdXRUZXh0O1xuICAgIGlmICh0aGlzLmZvcm1hdCA9PT0gJ3VzZXInKSB7XG4gICAgICAvLyBVc2VyIHByZXNlbnRhdGlvblxuICAgICAgY29uc3QgaXRlbXMgPSB7XG4gICAgICAgICdzZWNvbmRzJzogdGhpcy5zZWNvbmRzLFxuICAgICAgICAnbWludXRlcyc6IHRoaXMubWludXRlcyxcbiAgICAgICAgJ2hvdXJzJzogdGhpcy5ob3VycyxcbiAgICAgICAgJ2RheXMnOiB0aGlzLmRheXNcbiAgICAgIH07XG5cbiAgICAgIG91dHB1dFRleHQgPSB0aGlzLm5nQ29udGVudFNjaGVtYTtcblxuICAgICAgZm9yIChjb25zdCBrZXkgb2YgT2JqZWN0LmtleXMoaXRlbXMpKSB7XG4gICAgICAgIG91dHB1dFRleHQgPSBvdXRwdXRUZXh0LnJlcGxhY2UoJ1snICsga2V5ICsgJ10nLCAoaXRlbXMgYXMgYW55KVtrZXldLnRvU3RyaW5nKCkpO1xuICAgICAgfVxuICAgIH0gZWxzZSBpZiAodGhpcy5mb3JtYXQgPT09ICdpbnRlbGxpJykge1xuICAgICAgLy8gSW50ZWxsaSBwcmVzZW50YXRpb25cbiAgICAgIG91dHB1dFRleHQgPSAnJztcbiAgICAgIGlmICh0aGlzLmRheXMgPiAwKSB7XG4gICAgICAgIG91dHB1dFRleHQgKz0gdGhpcy5kYXlzLnRvU3RyaW5nKCkgKyAnZGF5JyArICgodGhpcy5kYXlzID4gMSkgPyAncycgOiAnJykgKyAnICc7XG4gICAgICB9XG4gICAgICBpZiAoKHRoaXMuaG91cnMgPiAwKSB8fCAodGhpcy5kYXlzID4gMCkpIHtcbiAgICAgICAgb3V0cHV0VGV4dCArPSB0aGlzLmhvdXJzLnRvU3RyaW5nKCkgKyAnaCAnO1xuICAgICAgfVxuICAgICAgaWYgKCgodGhpcy5taW51dGVzID4gMCkgfHwgKHRoaXMuaG91cnMgPiAwKSkgJiYgKHRoaXMuZGF5cyA9PT0gMCkpIHtcbiAgICAgICAgb3V0cHV0VGV4dCArPSB0aGlzLm1pbnV0ZXMudG9TdHJpbmcoKS5wYWRTdGFydCgyLCAnMCcpICsgJ21pbiAnO1xuICAgICAgfVxuICAgICAgaWYgKCh0aGlzLmhvdXJzID09PSAwKSAmJiAodGhpcy5kYXlzID09PSAwKSkge1xuICAgICAgICBvdXRwdXRUZXh0ICs9IHRoaXMuc2Vjb25kcy50b1N0cmluZygpLnBhZFN0YXJ0KDIsICcwJykgKyAncyc7XG4gICAgICB9XG4gICAgfSBlbHNlIGlmICh0aGlzLmZvcm1hdCA9PT0gJ2htcycpIHtcbiAgICAgIC8vIEhtcyBwcmVzZW50YXRpb25cbiAgICAgIG91dHB1dFRleHQgPSB0aGlzLmhvdXJzLnRvU3RyaW5nKCkucGFkU3RhcnQoMiwgJzAnKSArICc6JztcbiAgICAgIG91dHB1dFRleHQgKz0gdGhpcy5taW51dGVzLnRvU3RyaW5nKCkucGFkU3RhcnQoMiwgJzAnKSArICc6JztcbiAgICAgIG91dHB1dFRleHQgKz0gdGhpcy5zZWNvbmRzLnRvU3RyaW5nKCkucGFkU3RhcnQoMiwgJzAnKTtcbiAgICB9IGVsc2Uge1xuICAgICAgLy8gRGVmYXVsdCBwcmVzZW50YXRpb25cbiAgICAgIG91dHB1dFRleHQgPSB0aGlzLmRheXMudG9TdHJpbmcoKSArICdkICc7XG4gICAgICBvdXRwdXRUZXh0ICs9IHRoaXMuaG91cnMudG9TdHJpbmcoKSArICdoICc7XG4gICAgICBvdXRwdXRUZXh0ICs9IHRoaXMubWludXRlcy50b1N0cmluZygpICsgJ20gJztcbiAgICAgIG91dHB1dFRleHQgKz0gdGhpcy5zZWNvbmRzLnRvU3RyaW5nKCkgKyAncyc7XG4gICAgfVxuXG4gICAgdGhpcy5yZW5kZXJlci5zZXRQcm9wZXJ0eSh0aGlzLmVsdC5uYXRpdmVFbGVtZW50LCAnaW5uZXJIVE1MJywgb3V0cHV0VGV4dCk7XG4gIH1cblxuICBwcml2YXRlIGNsZWFyKCkge1xuICAgIHRoaXMucmVzZXRUaW1lb3V0KCk7XG4gICAgdGhpcy50aW1lb3V0SWQgPSBudWxsO1xuICB9XG5cbiAgLyoqXG4gICAqIENvbXB1dGUgZWFjaCB1bml0IChzZWNvbmRzLCBtaW51dGVzLCBob3VycywgZGF5cykgZm9yIGZ1cnRoZXIgbWFuaXB1bGF0aW9uXG4gICAqIEBwcm90ZWN0ZWRcbiAgICovXG4gIHByb3RlY3RlZCBjb21wdXRlVGltZVVuaXRzKCkge1xuICAgIGlmICghdGhpcy5tYXhUaW1lVW5pdCB8fCB0aGlzLm1heFRpbWVVbml0ID09PSAnZGF5Jykge1xuICAgICAgdGhpcy5zZWNvbmRzICA9IE1hdGguZmxvb3IodGhpcy50aWNrQ291bnRlciAlIDYwKTtcbiAgICAgIHRoaXMubWludXRlcyAgPSBNYXRoLmZsb29yKCh0aGlzLnRpY2tDb3VudGVyIC8gNjApICUgNjApO1xuICAgICAgdGhpcy5ob3VycyAgICA9IE1hdGguZmxvb3IoKHRoaXMudGlja0NvdW50ZXIgLyAzNjAwKSAlIDI0KTtcbiAgICAgIHRoaXMuZGF5cyAgICAgPSBNYXRoLmZsb29yKCh0aGlzLnRpY2tDb3VudGVyIC8gMzYwMCkgLyAyNCk7XG4gICAgfSBlbHNlIGlmICh0aGlzLm1heFRpbWVVbml0ID09PSAnc2Vjb25kJykge1xuICAgICAgdGhpcy5zZWNvbmRzICA9IHRoaXMudGlja0NvdW50ZXI7XG4gICAgICB0aGlzLm1pbnV0ZXMgID0gMDtcbiAgICAgIHRoaXMuaG91cnMgICAgPSAwO1xuICAgICAgdGhpcy5kYXlzICAgICA9IDA7XG4gICAgfSBlbHNlIGlmICh0aGlzLm1heFRpbWVVbml0ID09PSAnbWludXRlJykge1xuICAgICAgdGhpcy5zZWNvbmRzICA9IE1hdGguZmxvb3IodGhpcy50aWNrQ291bnRlciAlIDYwKTtcbiAgICAgIHRoaXMubWludXRlcyAgPSBNYXRoLmZsb29yKHRoaXMudGlja0NvdW50ZXIgLyA2MCk7XG4gICAgICB0aGlzLmhvdXJzICAgID0gMDtcbiAgICAgIHRoaXMuZGF5cyAgICAgPSAwO1xuICAgIH0gZWxzZSBpZiAodGhpcy5tYXhUaW1lVW5pdCA9PT0gJ2hvdXInKSB7XG4gICAgICB0aGlzLnNlY29uZHMgID0gTWF0aC5mbG9vcih0aGlzLnRpY2tDb3VudGVyICUgNjApO1xuICAgICAgdGhpcy5taW51dGVzICA9IE1hdGguZmxvb3IoKHRoaXMudGlja0NvdW50ZXIgLyA2MCkgJSA2MCk7XG4gICAgICB0aGlzLmhvdXJzICAgID0gTWF0aC5mbG9vcih0aGlzLnRpY2tDb3VudGVyIC8gMzYwMCk7XG4gICAgICB0aGlzLmRheXMgICAgID0gMDtcbiAgICB9XG5cbiAgICB0aGlzLnJlbmRlclRleHQoKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBTdGFydCB0aWNrIGNvdW50LCBiYXNlIG9mIHRoaXMgY29tcG9uZW50XG4gICAqIEBwcm90ZWN0ZWRcbiAgICovXG4gIHByb3RlY3RlZCBzdGFydFRpY2tDb3VudCAoKSB7XG4gICAgY29uc3QgdGhhdCA9IHRoaXM7XG5cbiAgICB0aGF0LnRpbWVvdXRJZCA9IHNldEludGVydmFsKGZ1bmN0aW9uKCkge1xuICAgICAgbGV0IGNvdW50ZXI7XG5cbiAgICAgIGlmICh0aGF0LmNvdW50ZG93bikge1xuICAgICAgICAvLyBDb21wdXRlIGZpbmlzaCBjb3VudGVyIGZvciBjb3VudGRvd25cbiAgICAgICAgY291bnRlciA9IHRoYXQudGlja0NvdW50ZXI7XG5cbiAgICAgICAgaWYgKHRoYXQuc3RhcnRUaW1lID4gdGhhdC5lbmRUaW1lKSB7XG4gICAgICAgICAgY291bnRlciA9IHRoYXQudGlja0NvdW50ZXIgLSB0aGF0LmVuZFRpbWUgLSAxO1xuICAgICAgICB9XG4gICAgICB9IGVsc2Uge1xuICAgICAgICAvLyBDb21wdXRlIGZpbmlzaCBjb3VudGVyIGZvciB0aW1lclxuICAgICAgICBjb3VudGVyID0gdGhhdC50aWNrQ291bnRlciAtIHRoYXQuc3RhcnRUaW1lO1xuXG4gICAgICAgIGlmICh0aGF0LmVuZFRpbWUgPiB0aGF0LnN0YXJ0VGltZSkge1xuICAgICAgICAgIGNvdW50ZXIgPSB0aGF0LmVuZFRpbWUgLSB0aGF0LnRpY2tDb3VudGVyIC0gMTtcbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICB0aGF0LmNvbXB1dGVUaW1lVW5pdHMoKTtcblxuICAgICAgY29uc3QgdGltZXI6IFRpbWVJbnRlcmZhY2UgPSB7XG4gICAgICAgIHNlY29uZHM6IHRoYXQuc2Vjb25kcyxcbiAgICAgICAgbWludXRlczogdGhhdC5taW51dGVzLFxuICAgICAgICBob3VyczogdGhhdC5ob3VycyxcbiAgICAgICAgZGF5czogdGhhdC5kYXlzLFxuICAgICAgICB0aW1lcjogdGhhdC50aW1lb3V0SWQsXG4gICAgICAgIHRpY2tfY291bnQ6IHRoYXQudGlja0NvdW50ZXJcbiAgICAgIH07XG5cbiAgICAgIHRoYXQub25UaWNrLmVtaXQodGltZXIpO1xuXG4gICAgICBpZiAoY291bnRlciA8IDApIHtcbiAgICAgICAgdGhhdC5zdG9wKCk7XG5cbiAgICAgICAgdGhhdC5vbkNvbXBsZXRlLmVtaXQodGhhdCk7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cblxuICAgICAgaWYgKHRoYXQuY291bnRkb3duKSB7XG4gICAgICAgIHRoYXQudGlja0NvdW50ZXItLTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHRoYXQudGlja0NvdW50ZXIrKztcbiAgICAgIH1cbiAgICB9LCAxMDAwKTsgLy8gRWFjaCBzZWNvbmRzXG4gIH1cblxufVxuIl19